<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<title>BetaCreator - Climbing topo tool</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link rel="stylesheet" type="text/css" href="stylesheets/betacreator.css" media="all" />
	<script src="javascripts/betacreator.js"></script>
	<script src="javascripts/main.js"></script>

	<style type="text/css">
	* { margin: 0; padding: 0; }
	body { font-family: sans-serif; }
	html, body, #bc {
		display: flex;
		width: 100%;
		height: 100%;
		overflow: hidden;
	}
	#bc {
		flex-direction: column;
	}
	#bc p {
		height: 2em;
		padding: .5em;
		display: flex;
		align-items: center;
		justify-content: space-between;
		background: #ccc;
	}
	#container {
		height: calc(100% - 3em);
	}
	#bc p button, #bc p #name {
		padding: .3em;
		font-size: 1rem;
		border-radius: .2em;
		border: none;
		box-shadow: 0px 0px 10px #666;
		background: #fff;
		cursor: pointer;
	}
	#src {
		display: none;
	}
	#name {
		display: flex;
		gap: .5rem;
		align-items: center;
		justify-content: center;
	}
	</style>
</head>
<body>

<div id="bc">
  <p>
  	<span id="name">
  		<svg fill="none" height="24" viewBox="0 0 32 32" width="24" xmlns="http://www.w3.org/2000/svg"><path d="m16.8333 10h8.1667c1.1487 0 2 .8513 2 2v1l-13 10.5-11.39062 4.7305c-.38839-.6003-.60938-1.4577-.60938-2.2305v-17.91966c0-1.14874.93156-2.08034 2.08027-2.08034h6.67503c.8087 0 1.5843.3201 2.1577.89041l2.4527 2.49716c.39.38749.9179.61243 1.4676.61243z" fill="#ffb02e"/><path d="m27.911 13h-17.025c-.7582.0002-1.49783.2346-2.11771.6711-.61989.4366-1.08973 1.054-1.34528 1.7679-4.591 13.165-4.212 12.2189-4.328 12.3669-.04908.0758-.1161.1383-.19513.1819s-.16762.067-.25787.0681c-.06449-.0008-.1275-.0195-.18201-.0539.34169.643.8617 1.1738 1.49762 1.5285.63592.3548 1.36074.5185 2.0874.4715h17.95198c.4363-.0021.8605-.1445 1.2096-.4062.3492-.2616.6049-.6286.7294-1.0468l3.962-12.835c.0988-.3124.1227-.6437.0696-.9669-.0531-.3233-.1816-.6295-.3752-.8938-.1935-.2644-.4465-.4793-.7387-.6276-.2921-.1482-.6151-.2256-.9427-.2257z" fill="#fcd53f"/></svg>
  		<b>Click here to open an image</b><i></i>
  	</span>
	<input type="file" id="src" />
	<span>
		<button onClick="downloadData()">Download data</button>
		<button onClick="exportImage()">Export image</button>
	</span>
  </p>
  <div id="container">
  </div>
</div>

<script type="text/javascript">
var betaCreator = null;
var timer = null;

function init() {
	const src = document.querySelector('#src');
	const container = document.querySelector('#container');
	document.querySelector('#name').onclick = () => src.click();

	src.onchange = () => {
		if (src.files.length != 1) {
			return;
		}

		const f = src.files[0];

		// If image, add preview thumbnail
		if (!f.type.startsWith('image/')) {
			alert('This file is not an image');
			src.value = '';
			return;
		}

		if (betaCreator && !confirm('Warning: this will DELETE your topo! Click OK to DELETE!')) {
			src.value = '';
			return;
		}

		const reader = new FileReader();
		reader.onload = (e) => {
			localStorage.bcImage = null;
			localStorage.bcData = null;
			loadImage(e.target.result, f.name, false);
		};
		reader.readAsDataURL(f);
	}

	if (localStorage.bcImage) {
		loadImage(localStorage.bcImage, localStorage.bcName, true);
	}
}

function loadImage(url, file_name, load_data) {
	container.innerHTML = '';
	const img = document.createElement('img');
	container.appendChild(img);

	img.onload = () => {
		localStorage.bcImage = img.src;
		localStorage.bcName = file_name;

		BetaCreator(img, function() {
			betaCreator = this;
			if (load_data && localStorage.bcData) {
				console.log(localStorage.bcData);
				betaCreator.loadData(localStorage.bcData);
			}
			document.querySelector('#name b').innerText = file_name;
			window.clearInterval(timer);
			timer = window.setInterval(() => {
				localStorage.bcData = betaCreator.getData();
				console.log(localStorage.bcData);
			}, 5000);
		},{
			zoom: 'contain',
			height: '100%',
			width: '100%'
		});
	};

	img.src = url;
}

function downloadData() {
	const blob = new Blob([JSON.stringify(betaCreator.getData())], { type: "application/json" });
	const temp_object_url = window.URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.style.display = 'none';
	a.href = temp_object_url;
	a.download = localStorage.bcName + '_betacreator.json';
	document.body.appendChild(a);
	a.click();
	window.URL.revokeObjectURL(temp_object_url);
	a.remove();
}

function exportImage() {
	const a = document.createElement('a');
	a.style.display = 'none';
	a.href = betaCreator.getImage(true, 'png');
	a.download = localStorage.bcName.replace(/\.[a-z]+$/, '_betacreator.png');
	document.body.appendChild(a);
	a.click();
	a.remove();
}

init();
</script>

</body>
</html>
